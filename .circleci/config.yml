version: 2.1

# Orbs for common functionality
orbs:
  node: circleci/node@5.1.0
  android: circleci/android@3.1.1
  path-filtering: circleci/path-filtering@0.1.3

# Jobs for Platform app
jobs:
  platform-test:
    docker:
      - image: cimg/node:20.19.0
    working_directory: ~/mono/platform
    steps:
      - checkout
      - node/install-packages:
          pkg-manager: npm
          app-dir: platform
      - run:
          name: Type check
          command: npm run check
      - run:
          name: Run tests
          command: npm run test:run
      - store_test_results:
          path: platform/test-results
      - store_artifacts:
          path: platform/coverage

  platform-build:
    docker:
      - image: cimg/node:20.19.0
    working_directory: ~/mono/platform
    steps:
      - checkout
      - node/install-packages:
          pkg-manager: npm
          app-dir: platform
      - run:
          name: Build
          command: npm run build
      - store_artifacts:
          path: platform/dist

  platform-e2e:
    docker:
      - image: cimg/node:20.19.0
    working_directory: ~/mono/platform
    steps:
      - checkout
      - node/install-packages:
          pkg-manager: npm
          app-dir: platform
      - run:
          name: Install Playwright browsers
          command: npx playwright install --with-deps chromium
      - run:
          name: Run E2E tests
          command: npm run test:e2e
      - store_test_results:
          path: platform/test-results
      - store_artifacts:
          path: platform/playwright-report

  # Jobs for Landing Page app
  landing-page-test:
    docker:
      - image: cimg/node:20.19.0
    working_directory: ~/mono/landing-page
    steps:
      - checkout
      - node/install-packages:
          pkg-manager: npm
          app-dir: landing-page
      - run:
          name: Lint
          command: npm run lint || echo "Linting failed but continuing"
      - run:
          name: Build
          command: npm run build
      - store_artifacts:
          path: landing-page/.next

  # Jobs for Status app
  status-test:
    docker:
      - image: cimg/node:20.19.0
    working_directory: ~/mono/status
    steps:
      - checkout
      - run:
          name: Test health check script
          command: |
            cd status
            # Basic syntax check
            node -c check-health.js
            echo "Health check script syntax is valid"

  # Jobs for Android app
  android-build:
    docker:
      - image: cimg/android:2024.01.1
    working_directory: ~/mono/chyme-android
    steps:
      - checkout
      - android/restore-gradle-cache
      - run:
          name: Build Android app
          command: |
            cd chyme-android
            ./gradlew assembleDebug
      - android/save-gradle-cache
      - store_artifacts:
          path: chyme-android/app/build/outputs

  android-test:
    docker:
      - image: cimg/android:2024.01.1
    working_directory: ~/mono/chyme-android
    steps:
      - checkout
      - android/restore-gradle-cache
      - run:
          name: Run Android tests
          command: |
            cd chyme-android
            ./gradlew test
      - android/save-gradle-cache
      - store_test_results:
          path: chyme-android/app/build/test-results
      - store_artifacts:
          path: chyme-android/app/build/reports

# Workflows with path filtering
workflows:
  version: 2
  
  # Main workflow that filters by path
  monorepo:
    jobs:
      # Platform app jobs - only run if platform/ or .circleci/ changes
      - path-filtering/filter:
          name: check-platform-changes
          base-revision: << pipeline.git.base_revision >>
          paths:
            - platform/**
            - .circleci/**
      - platform-test:
          requires:
            - check-platform-changes
          filters:
            branches:
              only: /.*/
      - platform-build:
          requires:
            - platform-test
          filters:
            branches:
              only: /.*/
      - platform-e2e:
          requires:
            - platform-build
          filters:
            branches:
              only: /main|master|develop/

      # Landing page jobs - only run if landing-page/ or .circleci/ changes
      - path-filtering/filter:
          name: check-landing-page-changes
          base-revision: << pipeline.git.base_revision >>
          paths:
            - landing-page/**
            - .circleci/**
      - landing-page-test:
          requires:
            - check-landing-page-changes
          filters:
            branches:
              only: /.*/

      # Status app jobs - only run if status/ or .circleci/ changes
      - path-filtering/filter:
          name: check-status-changes
          base-revision: << pipeline.git.base_revision >>
          paths:
            - status/**
            - .circleci/**
      - status-test:
          requires:
            - check-status-changes
          filters:
            branches:
              only: /.*/

      # Android app jobs - only run if chyme-android/ or .circleci/ changes
      - path-filtering/filter:
          name: check-android-changes
          base-revision: << pipeline.git.base_revision >>
          paths:
            - chyme-android/**
            - .circleci/**
      - android-test:
          requires:
            - check-android-changes
          filters:
            branches:
              only: /.*/
      - android-build:
          requires:
            - android-test
          filters:
            branches:
              only: /.*/
