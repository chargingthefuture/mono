name: Build and Release Android APK

on:
  release:
    types: [created]
  workflow_dispatch: # Allows manual triggering
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'
    - name: Install Gradle 8.9
      run: |
        wget -q https://services.gradle.org/distributions/gradle-8.9-bin.zip
        unzip -q gradle-8.9-bin.zip
        echo "$PWD/gradle-8.9/bin" >> $GITHUB_PATH
    - name: Make gradlew executable
      working-directory: chyme-android
      run: |
        if [ -f "./gradlew" ]; then
          chmod +x gradlew
        fi
    - name: Verify signing credentials are set
      working-directory: chyme-android
      run: |
        if [ -z "${{ secrets.KEYSTORE_PASSWORD }}" ]; then
          echo "ERROR: KEYSTORE_PASSWORD secret is not set!"
          exit 1
        fi
        if [ -z "${{ secrets.KEYSTORE_PATH }}" ]; then
          echo "ERROR: KEYSTORE_PATH secret is not set!"
          exit 1
        fi
        echo "✓ Signing credentials are configured"
    - name: Build release APK
      working-directory: chyme-android
      env:
        PLATFORM_API_BASE_URL: ${{ secrets.PLATFORM_API_BASE_URL }}
        KEYSTORE_PATH: ${{ secrets.KEYSTORE_PATH }}
        KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
        KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
        KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
      run: |
        if [ -f "./gradlew" ]; then
          ./gradlew assembleRelease --no-daemon
        else
          gradle assembleRelease --no-daemon
        fi
    - name: Find and verify APK
      id: apk
      working-directory: chyme-android
      run: |
        # Only look for signed APK - unsigned APKs should not exist
        if [ -f "app/build/outputs/apk/release/app-release.apk" ]; then
          APK_PATH="app/build/outputs/apk/release/app-release.apk"
          echo "APK found at $APK_PATH"
          echo "apk_path=$APK_PATH" >> $GITHUB_OUTPUT
        else
          echo "ERROR: Signed APK not found at app/build/outputs/apk/release/app-release.apk"
          echo "Searching for APK files..."
          find app/build/outputs -name "*.apk" -type f 2>/dev/null || echo "No APK files found"
          if [ -f "app/build/outputs/apk/release/app-release-unsigned.apk" ]; then
            echo "ERROR: Found unsigned APK! This should not happen - signing is mandatory."
            exit 1
          fi
          echo "Build outputs directory structure:"
          find app/build/outputs -type d 2>/dev/null | head -20 || echo "No outputs directory found"
          exit 1
        fi
        ls -lh "$APK_PATH"
    - name: Verify APK is signed (MANDATORY)
      working-directory: chyme-android
      run: |
        APK_PATH="${{ steps.apk.outputs.apk_path }}"
        if [ -z "$APK_PATH" ]; then
          echo "ERROR: APK path is not set"
          exit 1
        fi
        
        echo "Verifying APK signature..."
        # Check if APK contains signature files in META-INF/
        # Signed APKs must contain at least one of: .RSA, .DSA, or .EC files
        SIGNATURE_FILES=$(unzip -l "$APK_PATH" 2>/dev/null | grep -E "META-INF/.*\.(RSA|DSA|EC|SF)" | wc -l)
        
        if [ "$SIGNATURE_FILES" -eq 0 ]; then
          echo "ERROR: APK is NOT signed! No signature files found in META-INF/"
          echo "This APK cannot be released. Signing is mandatory."
          echo ""
          echo "Checking APK contents:"
          unzip -l "$APK_PATH" | grep "META-INF/" | head -10
          exit 1
        else
          echo "✓ APK is signed (found $SIGNATURE_FILES signature file(s) in META-INF/)"
          echo ""
          echo "Signature files found:"
          unzip -l "$APK_PATH" 2>/dev/null | grep -E "META-INF/.*\.(RSA|DSA|EC|SF)"
        fi
        
        # Additional check: Verify the APK is not the unsigned variant
        if echo "$APK_PATH" | grep -q "unsigned"; then
          echo "ERROR: APK path contains 'unsigned' - this APK should not be released!"
          exit 1
        fi
    - name: Get version name
      id: version
      working-directory: chyme-android
      run: |
        VERSION=$(grep -oP 'versionName\s+"\K[^"]+' app/build.gradle.kts || echo "unknown")
        echo "version=$VERSION" >> $GITHUB_OUTPUT
    - name: Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: app-release
        path: chyme-android/${{ steps.apk.outputs.apk_path }}
        retention-days: 30
        if-no-files-found: error
    - name: Upload APK to Release
      if: github.event_name == 'release'
      uses: softprops/action-gh-release@v1
      with:
        files: chyme-android/${{ steps.apk.outputs.apk_path }}
        body: |
          ## Chyme Android App
          **Version:** ${{ steps.version.outputs.version }}
          ### Installation Instructions
          1. Download the APK file above
          2. On your Android device, enable "Install from Unknown Sources" in Settings
          3. Open the downloaded APK file
          4. Follow the installation prompts
          ### Requirements
          - Android 7.0 (API level 24) or higher
          ### What's New
          See the release notes for details.
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
