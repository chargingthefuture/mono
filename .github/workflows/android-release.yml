name: Build and Release Android APK

on:
  release:
    types: [created]
  workflow_dispatch: # Allows manual triggering

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'
        
    - name: Setup Gradle
      uses: gradle/gradle-build-action@v2
      with:
        gradle-version: '8.2'
        # Cache will be read/written, but if cache service is down, build will still succeed
        cache-read-only: false
        
    - name: Make gradlew executable
      working-directory: chyme-android
      run: |
        if [ -f "./gradlew" ]; then
          chmod +x gradlew
        fi
        
    - name: Build release APK
      working-directory: chyme-android
      env:
        CLERK_PUBLISHABLE_KEY: ${{ secrets.CLERK_PUBLISHABLE_KEY }}
        PLATFORM_API_BASE_URL: ${{ secrets.PLATFORM_API_BASE_URL }}
      run: |
        if [ -f "./gradlew" ]; then
          ./gradlew assembleRelease --no-daemon
        else
          gradle assembleRelease --no-daemon
        fi
      
    - name: Get version name
      id: version
      working-directory: chyme-android
      run: |
        VERSION=$(grep -oP 'versionName\s+"\K[^"]+' app/build.gradle.kts || echo "unknown")
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        
    - name: Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: app-release
        path: chyme-android/app/build/outputs/apk/release/app-release.apk
        retention-days: 30
        
    - name: Upload APK to Release
      if: github.event_name == 'release'
      uses: softprops/action-gh-release@v1
      with:
        files: chyme-android/app/build/outputs/apk/release/app-release.apk
        body: |
          ## Chyme Android App
          
          **Version:** ${{ steps.version.outputs.version }}
          
          ### Installation Instructions
          
          1. Download the APK file above
          2. On your Android device, enable "Install from Unknown Sources" in Settings
          3. Open the downloaded APK file
          4. Follow the installation prompts
          
          ### Requirements
          
          - Android 7.0 (API level 24) or higher
          
          ### What's New
          
          See the release notes for details.
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

