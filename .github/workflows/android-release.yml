name: Build and Release Android APK

on:
  push:
    branches: [ main ]
    paths:
      - 'chyme-android/**'
      - '.github/workflows/android-release.yml'
  pull_request:
    branches: [ main ]
    paths:
      - 'chyme-android/**'
      - '.github/workflows/android-release.yml'

jobs:
  build:
    runs-on: ubuntu-24.04

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Install Gradle 8.9
        run: |
          wget -q https://services.gradle.org/distributions/gradle-8.9-bin.zip
          unzip -q gradle-8.9-bin.zip
          echo "$PWD/gradle-8.9/bin" >> $GITHUB_PATH

      - name: Prepare Android keystore
        run: |
          mkdir -p chyme-android
          # Decode the keystore from the KEYSTORE_FILE_BASE64 secret
          echo "$KEYSTORE_FILE_BASE64" | base64 -d > chyme-android/chyme-release-key.jks
          # Tell Gradle where the keystore is (relative to chyme-android root)
          echo "KEYSTORE_PATH=chyme-release-key.jks" >> "$GITHUB_ENV"
          echo "✓ Signing keystore written to chyme-android/chyme-release-key.jks"
        env:
          KEYSTORE_FILE_BASE64: ${{ secrets.KEYSTORE_FILE_BASE64 }}

      - name: Check signing secrets
        run: |
          if [ -z "${KEYSTORE_PASSWORD}" ]; then
            echo "ERROR: KEYSTORE_PASSWORD secret is not set!"
            exit 1
          fi
          if [ -z "${KEY_ALIAS}" ]; then
            echo "ERROR: KEY_ALIAS secret is not set!"
            exit 1
          fi
          if [ -z "${KEY_PASSWORD}" ]; then
            echo "ERROR: KEY_PASSWORD secret is not set!"
            exit 1
          fi
          echo "✓ Signing credentials are configured"
        env:
          KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}

      - name: Assemble Android release
        working-directory: chyme-android
        run: |
          if [ -f "./gradlew" ]; then
            chmod +x gradlew
            ./gradlew assembleRelease --no-daemon
          else
            gradle assembleRelease --no-daemon
          fi
        env:
          PLATFORM_API_BASE_URL: ${{ secrets.PLATFORM_API_BASE_URL }}
          # From the Prepare Android keystore step (GITHUB_ENV)
          KEYSTORE_PATH: ${{ env.KEYSTORE_PATH }}
          KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}