name: Push Database Schema to Neon

on:
  push:
    branches:
      - main
    paths:
      - 'platform/shared/schema.ts'
      - 'platform/shared/schema/**'
      - 'platform/drizzle.config.ts'
      - '.github/workflows/neon_database_migration.yml'
  workflow_dispatch: # Manual trigger - useful for fixing sync issues
    inputs:
      environment:
        description: 'Which database to update (auto-detected on push to main)'
        required: false
        type: choice
        options:
          - production
          - staging
        default: 'production'

jobs:
  push-schema:
    name: Push Schema to ${{ github.event.inputs.environment || 'production' }}
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.19.0'
          cache: 'npm'
          cache-dependency-path: platform/package-lock.json

      - name: Install dependencies
        working-directory: platform
        run: npm ci

      - name: Determine environment
        id: set_db_url
        run: |
          # Manual trigger: use input, default to production
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            ENV="${{ github.event.inputs.environment || 'production' }}"
          # Auto trigger on push: main = production
          elif [ "${{ github.ref }}" == "refs/heads/main" ]; then
            ENV="production"
          else
            ENV="production" # Default fallback
          fi
          
          echo "environment=$ENV" >> $GITHUB_OUTPUT
          echo "✓ Will update $ENV database"

      - name: Push database schema
        working-directory: platform
        env:
          DATABASE_URL: ${{ steps.set_db_url.outputs.environment == 'staging' && secrets.DATABASE_URL_STAGING || secrets.DATABASE_URL }}
        run: |
          echo "Pushing schema to ${{ steps.set_db_url.outputs.environment }} database..."
          echo "Schema files changed, running: npm run db:push"
          npm run db:push

      - name: Verify push completed
        run: |
          echo "✓ Schema push completed successfully for ${{ steps.set_db_url.outputs.environment }}"
          echo ""
          echo "Note: If db:push timed out, you can manually paste schema.sql into the Neon console."
