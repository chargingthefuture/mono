# Example workflow for Firebase Test Lab (cloud-based Android testing)
# This requires Firebase project setup and authentication
#
# To use this:
# 1. Set up a Firebase project at https://console.firebase.google.com
# 2. Create a service account and download the JSON key
# 3. Add the JSON key as a GitHub secret named FIREBASE_SERVICE_ACCOUNT
# 4. Rename this file to android-firebase-test-lab.yml
# 5. Install the Firebase Test Lab action: https://github.com/marketplace/actions/firebase-test-lab-action

name: android-firebase-test-lab

on:
  workflow_dispatch: {}
  push:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest

    env:
      JAVA_VERSION: '17'
      ANDROID_API_LEVEL: 30
      ANDROID_BUILD_TOOLS: '34.0.0'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: ${{ env.JAVA_VERSION }}

      - name: Set up Android SDK
        uses: android-actions/setup-android@v3

      - name: Install required SDK packages
        run: |
          sdkmanager "platforms;android-${ANDROID_API_LEVEL}" "build-tools;${ANDROID_BUILD_TOOLS}" "platform-tools"

      - name: Build debug APK
        working-directory: chyme-android
        run: |
          chmod +x gradlew
          ./gradlew :app:assembleDebug --no-daemon

      - name: Run tests on Firebase Test Lab
        uses: asadmansr/Firebase-Test-Lab-Action@v1.0.2
        with:
          service_account_email: ${{ secrets.FIREBASE_SERVICE_ACCOUNT_EMAIL }}
          service_account_key: ${{ secrets.FIREBASE_SERVICE_ACCOUNT }}
          project_id: ${{ secrets.FIREBASE_PROJECT_ID }}
          apk_path: chyme-android/app/build/outputs/apk/debug/app-debug.apk
          device_ids: |
            - model: Pixel2
              version: 30
              orientation: portrait
          timeout: 5m
          results_bucket: ${{ secrets.FIREBASE_RESULTS_BUCKET }}
          results_dir: test-results

      - name: Download test results
        uses: actions/download-artifact@v4
        with:
          name: firebase-test-results
          path: firebase-test-results

